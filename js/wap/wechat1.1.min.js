var INNORMAL="innormal";var NODELIVERY="nodelivery";var ENCLOSED="enclosed";var RECSORT="recsort";var RECPRODUCT="recproduct";var LIMITORDERNUM=30;var isfirstinit=true;var ispayable=true;var needdeliveryfee=false;var issubmittable=false;var totalpay=0;var totalordernum=0;var overleft=false;var mydatasource=null;var sortarray=null;var productarray=null;var deliveryareaarray=null;var recommendarray=null;var shopinfo=null;var recommendsortmap=null;var product2ordermap=null;var sortmap=null;var productmap=null;var areamap=null;var orderarray=null;var mypersonalinfo=null;function order(a){this.productid=a;this.count=0}function personalinfo(c,b,d,e,a){this.uesrname=c;this.phonenumber=b;this.areaid=d;this.areadesc=e;this.tips=a}function hashMap(){this.Set=function(a,b){this[a]=b},this.Get=function(a){return this[a]},this.Contains=function(a){return this.Get(a)==null?false:true},this.Remove=function(a){delete this[a]}}function firstinit(){baseeventbind();dataload(true,true,true,true,true)}function baseeventbind(){$(document).ajaxStart(function(){startloading("正在进行数据交换")});$(document).ajaxStop(function(){stoploading()});$(document).ajaxError(function(){stoploading()})}function dataload(a,c,e,d,b){$.ajax({type:"POST",dataType:"json",url:AJAXFORDATA,data:{sellerid:sellerid,needsort:a,needproduct:c,needdeliveryarea:e,needrecommend:d,needshopinfo:b},success:function(g){if(g.error=="0"){if(mydatasource==null){mydatasource=g}else{datasourcetemp=g;mydatasource.sortdata=a?datasourcetemp.sortdata:mydatasource.sortdata;mydatasource.productdata=c?datasourcetemp.productdata:mydatasource.productdata;mydatasource.deliveryareadata=e?datasourcetemp.deliveryareadata:mydatasource.deliveryareadata;mydatasource.recommenddata=d?datasourcetemp.recommenddata:mydatasource.recommenddata;mydatasource.shopinfodata=b?datasourcetemp.shopinfodata:mydatasource.shopinfodata}if(mydatasource.sortdata==null||mydatasource.productdata==null||mydatasource.deliveryareadata==null||mydatasource.shopinfodata==null){var f=function(){dataload(mydatasource.sortdata==null,mydatasource.productdata==null,mydatasource.deliveryareadata==null,d,mydatasource.shopinfodata==null)};$(currentcontent).hide();callerror(WRONGDATA,f)}else{datarefresh()}}else{var f=function(){dataload(a,c,e,d,b)};$(currentcontent).hide();callerror(WRONGDATA,f)}},error:function(g,i,h){var f=function(){dataload(a,c,e,d,b)};$(currentcontent).hide();callerror(WRONGDATA,f)}})}function orderload(){$.ajax({type:"POST",dataType:"json",url:AJAXFORRESULT,data:{sellerid:sellerid,wapKey:identitykey,openid:openid,endtime:null,num:1},success:function(a,c){if(a.success=="1"){callsuccesspay(a.result[0])}else{var b=function(){$(currentcontent).show();orderload()};$(currentcontent).hide();callerror(WRONGDATA,b)}},error:function(a,d,b){var c=function(){$(currentcontent).show();orderload()};$(currentcontent).hide();callerror(WRONGDATA,c)}})}function datarefresh(){sortarray=mydatasource.sortdata;productarray=mydatasource.productdata;deliveryareaarray=mydatasource.deliveryareadata;shopinfo=mydatasource.shopinfodata;recommendarray=mydatasource.recommenddata;datamaprefresh();if(shopinfo.shopstatus==NODELIVERY||shopinfo.shopstatus==ENCLOSED||shopinfo.servertime<shopinfo.begintime||shopinfo.servertime>shopinfo.endtime){ispayable=false}readhistory();if(isfirstinit){isfirstinit=false;firstcallcontent()}else{refreshcontent()}}function readhistory(){readorderlocal();readinfolocal()}function readorderlocal(){orderarray=new Array();if(localStorage){if(localStorage.getItem(sellerid+"-"+openid+"-"+"order")){var b=localStorage.getItem(sellerid+"-"+openid+"-"+"order").split("&");var d=0;for(var c=0;c<b.length;c++){var a=b[c].split("*");if(findproductbyid(a[0])>=0){orderarray[d]=new order(a[0]);orderarray[d].count=parseInt(a[1]);d++}}}}ordermaprefresh();calctotalpay()}function writeorderlocal(){if(localStorage){var a="";for(var b=0;b<orderarray.length;b++){if(orderarray[b].count>0&&productmap.Contains(orderarray[b].productid)&&a==""){a+=orderarray[b].productid+"*"+orderarray[b].count}else{if(orderarray[b].count>0&&productmap.Contains(orderarray[b].productid)&&a!=""){a+="&";a+=orderarray[b].productid+"*"+orderarray[b].count}}}localStorage.setItem(sellerid+"-"+openid+"-"+"order",a)}calctotalpay()}function readinfolocal(){mypersonalinfo=new personalinfo();if(localStorage){if(localStorage.getItem(sellerid+"-"+openid+"-"+"info")){var a=localStorage.getItem(sellerid+"-"+openid+"-"+"info").split("&");mypersonalinfo=new personalinfo(a[0],a[1],a[2],a[3],null)}}}function writeinfolocal(c,a,e,b){mypersonalinfo.uesrname=c;mypersonalinfo.phonenumber=a;mypersonalinfo.areaid=e;mypersonalinfo.areadesc=b;if(localStorage){var d=mypersonalinfo.uesrname+"&"+mypersonalinfo.phonenumber+"&"+mypersonalinfo.areaid+"&"+mypersonalinfo.areadesc;localStorage.setItem(sellerid+"-"+openid+"-"+"info",d)}}function deleteorder(c){var d=findorderbyid(c);var b=false;var a=false;if(d>=0){if(orderarray[d].count>=1){orderarray[d].count--;b=true}if(orderarray[d].count==0){a=true
}}if(b){if(!a){writeorderlocal()}else{writeorderlocal();readorderlocal()}return true}else{return false}}function addorder(d){var g=findproductbyid(d);var f=findorderbyid(d);var c=false;var b=false;if(totalordernum<LIMITORDERNUM){if(g>=0&&f>=0){if(orderarray[f].count>=0&&orderarray[f].count<productarray[g].productleft){orderarray[f].count++;c=true;if(orderarray[f].count==productarray[g].productleft){var a="您选购的"+productarray[g].productname+"已达库存上限！";Toast(a,2000)}}}else{if(g>=0&&f<0){var e=orderarray.length;orderarray[e]=new order(d);orderarray[e].count++;c=true;b=true;if(orderarray[e].count==productarray[g].productleft){var a="您选购的"+productarray[g].productname+"已达库存上限！";Toast(a,2000)}}}}else{var a="您的单次订单量已达上限！";Toast(a,2000)}if(c){if(!b){writeorderlocal()}else{writeorderlocal();readorderlocal()}return true}else{return false}}function clearorder(){orderarray=new Array();writeorderlocal();readorderlocal();return true}function calctotalpay(){var b=0;var c=0;var a=false;var e=false;for(var d=0;d<orderarray.length;d++){if(orderarray[d].count>0){var f=findproductbyid(orderarray[d].productid);if(f>=0){c+=parseInt(orderarray[d].count);b+=((productarray[f].price*100)*orderarray[d].count)/100;if(orderarray[d].count>productarray[f].productleft){a=true}}}}if(b<shopinfo.sendingfee&&c>0&&shopinfo.deliveryfee>0){b+=parseInt(shopinfo.deliveryfee);e=true}else{if(b>=shopinfo.sendingfee&&c>0&&!shopinfo.isdeliveryfree&&shopinfo.deliveryfee>0){b+=parseInt(shopinfo.deliveryfee);e=true}else{e=false}}if(b<shopinfo.sendingfee&&c>0&&shopinfo.isdeliveryfree){issubmittable=true}else{if(b>=shopinfo.sendingfee&&c>0){issubmittable=true}else{issubmittable=false}}totalpay=b;totalordernum=c;overleft=a;needdeliveryfee=e;return b}function findproductbyid(a){return productmap.Contains(a)?productmap.Get(a):-1}function findorderbyid(a){return product2ordermap.Contains(a)?product2ordermap.Get(a):-1}function findsortbyid(a){return sortmap.Contains(a)?sortmap.Get(a):-1}function findarerbyid(a){return deliveryareamap.Contains(a)?deliveryareamap.Get(a):-1}function findrecommendbyid(a){return recommendsortmap.Contains(a)?recommendsortmap.Get(a):-1}function ordermaprefresh(){product2ordermap=new hashMap();for(var a=0;a<orderarray.length;a++){if(findproductbyid(orderarray[a].productid>=0)){product2ordermap.Set(orderarray[a].productid,a)}}}function datamaprefresh(){sortmap=new hashMap();for(var a=0;a<sortarray.length;a++){sortmap.Set(sortarray[a].sortid,a)}productmap=new hashMap();for(var a=0;a<productarray.length;a++){productmap.Set(productarray[a].productid,a)}deliveryareamap=new hashMap();for(var a=0;a<deliveryareaarray.length;a++){deliveryareamap.Set(deliveryareaarray[a].areaid,a)}recommendsortmap=new hashMap();for(var a=0;a<recommendarray.length;a++){if(recommendarray[a].recommendtype==RECSORT){recommendsortmap.Set(recommendarray[a].recommendid,a)}}}var SORTCONTENT="#sortcontent";var PRODUCTCONTENT="#productcontent";var PAYCONTENT="#paycontent";var PAYSUCCESS="#paysuccess";var SUBMITBTN="#submit-btn";var SORTBTN="#sort-btn";var BACKBTN="#back-btn";var PAYBTN="#pay-btn";var CLEARBTN="#clear-btn";var HAVELOOKBTN="#havelook-btn";var MINUSBTN=".button-minus";var PLUSBTN=".button-plus";var RIGHTARROR="rightarror";var NEWSTARTBTN="#newstart-btn";var INSLEEPBTN="insleepbtn";var ICONSIZE=20;var DESCSHOW="descshow";var DESCHIDE="deschide";var DESCNOEXIST="descnoexist";var currentsort=-1;var lastcontent="";var currentcontent="";var mytoasttimeout=null;var contentin=true;var productcontentscroll=0;var sortcontentscroll=0;var productcontentscrolltemp=0;var sortcontentscrolltemp=0;var lastchange=null;function showsortcontent(){basecontentprepare(SORTCONTENT);contentshow(SORTCONTENT)}function showproductcontent(a){if(findsortbyid(a)>=0){basecontentprepare(PRODUCTCONTENT);contentshow(PRODUCTCONTENT,a)}else{showsortcontent();Toast("该类别不存在",2000)}}function showpaycontent(){basecontentprepare(PAYCONTENT);contentshow(PAYCONTENT)}function basecontentprepare(a){contentin=true;switch(a){case SORTCONTENT:switch(currentcontent){case PAYCONTENT:contentin=false;break;case PRODUCTCONTENT:contentin=false;break}break;case PRODUCTCONTENT:switch(currentcontent){case PAYCONTENT:contentin=false;break}break}a!=SORTCONTENT?$(SORTCONTENT).hide():$(SORTCONTENT).show();a!=PRODUCTCONTENT?$(PRODUCTCONTENT).hide():$(PRODUCTCONTENT).show();a!=PAYCONTENT?$(PAYCONTENT).hide():$(PAYCONTENT).show();lastcontent=currentcontent;currentcontent=a}function personalinfoprepare(){var b="";b+='<label class="label-main">姓名:*</label><label class="label-tips" style="display:none"></label>'+'<input type="text" placeholder="请输入姓名" data-maxinput="10" data-nonull="true" onblur=checkinput(this) id="name" value="">'+'<label class="label-main">联系电话:*</label><label class="label-tips" style="display:none"></label>'+'<input id="number" placeholder="请输入联系电话" data-maxinput="20" data-nonull="true" onblur=checkinput(this) type="tel" value="">'+'<label class="label-main">请选择收货片区:*</label><label class="label-tips" style="display:none"></label>'+'<select id="select-area" onchange=checkselect(this)>';
for(var a=0;a<deliveryareaarray.length;a++){if(deliveryareaarray[a].areastatus==false){b+='<option value="'+deliveryareaarray[a].areaid+'" disabled="disabled">'+deliveryareaarray[a].areaname+"</option>"}else{b+='<option value="'+deliveryareaarray[a].areaid+'">'+deliveryareaarray[a].areaname+"</option>"}}b+="</select>"+'<label class="label-desc"></label>'+'<label class="label-main">详细收货地点:*</label><label class="label-tips" style="display:none"></label>'+'<textarea type="text" placeholder="请输入详细收货地址，如：仙1-202" data-maxinput="40" data-nonull="true" onblur=checkinput(this) id="areadesc" value=""></textarea>'+'<label class="label-main">备注:</label><label class="label-tips" style="display:none"></label>'+'<textarea type="text"  placeholder="请输入备注（如需使用会员卡，请留下卡号与登记时预留手机号，我们将与您电话核实）" data-maxinput="40" data-nonull="false" onblur=checkinput(this) id="tips" value=""></textarea>';$("#personalinfo-content").html(b);b="";b+='<button class="btn-icon-text" onclick=submit() id="submit-btn">'+'<span class="text-in-btn"id="submit">提交订单</span>'+'<span class="img-in-btn" style="background:'+getbackground(SUBMITBTN)+';"></span>'+"</button>";$("#submit-btnarea").html(b);$("#name").val(mypersonalinfo.uesrname);$("#number").val(mypersonalinfo.phonenumber);$("#select-area").val(mypersonalinfo.areaid);$("#areadesc").val(mypersonalinfo.areadesc);if(!(mypersonalinfo.areaid==null||mypersonalinfo.areaid=="")){checkselect("#select-area")}}function footerprepare(){$("#mainfooter").show();var a="";a='<button onclick = payback() id="back-btn" class="btn-icon" >'+'<span class="img-in-btn" style="background:'+getbackground(BACKBTN)+';"></span></button>'+'<button onclick = callsort() id="sort-btn" class="btn-icon">'+'<span class="img-in-btn" style="background:'+getbackground(SORTBTN)+';"></span></button>';$("#mainfooter .left-footer").html(a);a='<h4 id="paytitle">订单中心</h4>';$("#mainfooter .center-footer").html(a);a='<button onclick = topay() id="pay-btn" class="btn-icon-text">'+'<span class="text-in-btn">结算 ￥0</span>'+'<span class="img-in-btn" style="background:'+getbackground(PAYBTN)+';"></span></button>';$("#mainfooter .right-footer").html(a)}function contenteventbind(){$("#product-list,#order-list").on("click",MINUSBTN,function(a){myproductid=$(this).data("value");todeleteorder(myproductid);a.stopPropagation()});$("#product-list,#order-list").on("click",PLUSBTN,function(a){myproductid=$(this).data("value");toaddorder(myproductid);a.stopPropagation()});$("#product-list").on("click",".product-item",function(b){var a=b.target;var c=false;while(!$(a).is(".product-item")){if($(a).is(".btnarea-in-list")){c=true;break}a=$(a).parent()}if(!c){showitemdesc(this)}});$(window).scroll(function(){if(lastchange!=currentcontent){switch(lastchange){case PRODUCTCONTENT:productcontentscroll=productcontentscrolltemp;break;case SORTCONTENT:sortcontentscroll=sortcontentscrolltemp;break}lastchange=currentcontent;switch(lastchange){case PRODUCTCONTENT:productcontentscrolltemp=$(this).scrollTop();break;case SORTCONTENT:sortcontentscrolltemp=$(this).scrollTop();break}}else{switch(lastchange){case PRODUCTCONTENT:productcontentscrolltemp=$(this).scrollTop();break;case SORTCONTENT:sortcontentscrolltemp=$(this).scrollTop();break}}})}function contentshow(b,c){var a=currentsort;$(b).removeAttr("style");$(b).css("position","absolute");if(contentin){$(b).css("right","-100%")}else{$(b).css("left","-100%")}switch(b){case SORTCONTENT:fillsortcontent();break;case PRODUCTCONTENT:fillproductcontent(c);break;case PAYCONTENT:fillpaycontent();break}$(b).show();if(contentin){$(b).css("right","0")}else{$(b).css("left","0")}$(b).css("transition","all 200ms ease");$(b).css("position","relative");switch(b){case SORTCONTENT:window.scrollTo(0,1);window.scrollTo(0,sortcontentscroll);break;case PRODUCTCONTENT:if(c==a){window.scrollTo(0,1);window.scrollTo(0,productcontentscroll)}else{window.scrollTo(0,1)}break;case PAYCONTENT:window.scrollTo(0,1);break}}function fillsortcontent(){switch(shopinfo.shopstatus){case INNORMAL:if(!(shopinfo.servertime<shopinfo.endtime&&shopinfo.servertime>shopinfo.begintime)){$("#tips-sortcontent").show();$("#tips-title-sort").html("休息中(￣o￣). z Z");if(shopinfo.announcement!=""){var c="营业时间："+shopinfo.begintime+"-"+shopinfo.endtime;c+="<br />今日公告："+shopinfo.announcement;$("#tips-announcement-sort").html(c)}else{var c="营业时间："+shopinfo.begintime+"-"+shopinfo.endtime;$("#tips-announcement-sort").html(c)}}else{if(shopinfo.announcement!=""){$("#tips-sortcontent").show();$("#tips-title-sort").html("今日公告");$("#tips-announcement-sort").html(shopinfo.announcement)}else{$("#tips-sortcontent").hide()}}break;case NODELIVERY:$("#tips-sortcontent").show();$("#tips-title-sort").html("今天不能送外卖啦>_<");if(shopinfo.announcement!=""){$("#tips-announcement-sort").html(shopinfo.announcement)}else{$("#tips-announcement-sort").html("偷偷告诉你哦，实体店还是营业的，欢迎前来光临！")}break;case ENCLOSED:$("#tips-sortcontent").show();$("#tips-title-sort").html("歇业中>_<");if(shopinfo.announcement!=""){$("#tips-announcement-sort").html(shopinfo.announcement)
}else{$("#tips-announcement-sort").html("今天不开张啦，改日再会哦~")}break;default:$("#tips-sortcontent").hide()}var d="";for(var b=0;b<recommendarray.length;b++){if(recommendarray[b].recommendtype==RECSORT){for(var a=0;a<sortarray.length;a++){if(sortarray[a].sortid==recommendarray[b].objectid){d+='<li class="sort-item-rec" onclick = showproductcontent(\''+sortarray[a].sortid+"') >"+'<img src="'+BASEURL+recommendarray[b].recommendimg+'" alt="无真相>_<~">'+'<div class="mainarea-in-list">'+"<h4>"+sortarray[a].sortname+"</h4>"+"<h5>"+sortarray[a].sortdesc+"</h5>"+"</div>"+'<p class="p-aside">'+recommendarray[b].recommendtag+"</p>"+"</li>";sortarray[a].isrcommend=true}}}}$("#sort-recommendlist").html(d);d="";for(var b=0;b<sortarray.length;b++){if(findrecommendbyid(sortarray[b].sortid)==-1){d+='<li class="sort-item-nor" onclick = showproductcontent(\''+sortarray[b].sortid+"')>"+'<img src="'+BASEURL+sortarray[b].sortimg+'" alt="无真相>_<~">'+'<div class="list-item-icon" style="background:'+getbackground(RIGHTARROR)+';"></div>'+'<div class="mainarea-in-list">'+"<h4>"+sortarray[b].sortname+"</h4>"+"<h5>"+sortarray[b].sortdesc+"</h5>"+"</div>"+"</li>"}}$("#sort-normallist").html(d);setcontentshow(SORTCONTENT)}function fillproductcontent(d){var a=findsortbyid(d);var c="";currentsort=d;if(a>=0){c+='<li class="product-item" id="product-first-item"><div class="mainarea-in-list"><h4>'+sortarray[a].sortname+"</h4><h5>"+sortarray[a].sortdesc+"</h5></div></li>"}for(var b=0;b<productarray.length;b++){if(productarray[b].sortid==d){c+='<li class="product-item" id="product-'+productarray[b].productid+'" data-value="'+productarray[b].productid+'" data-descexist="'+DESCNOEXIST+'">'+'<div class="btnarea-in-list" >'+'<button class="btn-icon button-minus" data-value="'+productarray[b].productid+'" style="display:inline"><span class="img-in-btn" style="background:'+getbackground(MINUSBTN)+';"></span></button>'+'<button class="btn-icon button-plus" data-value="'+productarray[b].productid+'" style="display:inline"><span class="img-in-btn" style="background:'+getbackground(PLUSBTN)+';"></span></button>'+"</div>"+'<div class="tipsarea-in-list" disabled="disabled">'+"<h4></h4>"+"</div>"+'<div class="mainarea-in-list" >'+"<h4>"+productarray[b].productname+"</h4>"+"<h5>￥"+productarray[b].price+"</h5>"+"</div>"+'<p class="p-aside"></p>'+'<p class="showmore">···</p>'+"</li>"}}$("#product-list").html(c);setcontentshow(PRODUCTCONTENT)}function fillpaycontent(){var b="送达时间：约"+shopinfo.expecttime+"分钟";if(shopinfo.deliveryfee>0&&shopinfo.isdeliveryfree&&shopinfo.sendingfee>0){b+="<br />外送费用：￥"+shopinfo.deliveryfee+"（购满￥"+shopinfo.sendingfee+"免外送费）"}else{if(shopinfo.deliveryfee>0&&!shopinfo.isdeliveryfree&&shopinfo.sendingfee>0){b+="<br />外送费用：￥"+shopinfo.deliveryfee+"<br />起送价格：￥"+shopinfo.sendingfee}else{if(shopinfo.deliveryfee>0&&!(shopinfo.sendingfee>0)){b+="<br />外送费用：￥"+shopinfo.deliveryfee+"<br />起送价格：无"}else{if(!(shopinfo.deliveryfee>0)&&shopinfo.sendingfee>0){b+="<br />外送费用：无<br />起送价格：￥"+shopinfo.sendingfee}else{if(!(shopinfo.deliveryfee>0)&&!(shopinfo.sendingfee>0)){b+="<br />外送费用：无<br />起送价格：无"}}}}}$("#tips-announcement-order").html(b);var c="";c+='<li class="product-item" id="order-first-item">'+'<div class="btnarea-in-list">'+'<button class="btn-icon-text" onclick=havelook() id="havelook-btn">'+'<span class="text-in-btn" id="havelook">去逛逛</span>'+'<span class="img-in-btn" style="background:'+getbackground(HAVELOOKBTN)+';"></span>'+"</button>"+'<button class="btn-icon-text" onclick=toclearorder() id="clear-btn">'+'<span class="text-in-btn" id="clear">清空</span>'+'<span class="img-in-btn" style="background:'+getbackground(CLEARBTN)+';"></span>'+"</button>"+"</div>"+'<div class="mainarea-in-list"><h4></h4><h5></h5></div>'+"</li>";for(var a=0;a<orderarray.length;a++){if(orderarray[a].count>0){var d=findproductbyid(orderarray[a].productid);if(d>=0){c+='<li class="product-item" id="order-'+orderarray[a].productid+'">'+'<div class="btnarea-in-list" >'+'<button class="btn-icon button-minus" data-value="'+orderarray[a].productid+'" style="display:inline"><span class="img-in-btn" style="background:'+getbackground(MINUSBTN)+';"></span></button>'+'<button class="btn-icon button-plus " data-value="'+orderarray[a].productid+'" style="display:inline"><span class="img-in-btn" style="background:'+getbackground(PLUSBTN)+';"></span></button>'+"</div>"+'<div class="tipsarea-in-list" disabled="disabled">'+"<h4></h4>"+"</div>"+'<div class="mainarea-in-list" >'+"<h4>"+productarray[d].productname+"</h4>"+"<h5>￥"+productarray[d].price+"</h5>"+"</div>"+'<p class="p-aside"></p>'+"</li>"}else{orderarray[a].count=0}}}$("#order-list").html(c);setcontentshow(PAYCONTENT)}function setcontentshow(a){setcontentframeshow(a);switch(a){case PRODUCTCONTENT:for(var b=0;b<productarray.length;b++){if(productarray[b].sortid==currentsort){setproductitemshow(productarray[b].productid)}}break;case PAYCONTENT:for(var b=0;b<orderarray.length;b++){if(orderarray[b].count>0){setorderitemshow(orderarray[b].productid)
}}break}}function setcontentframeshow(a){switch(a){case SORTCONTENT:setfootershow(a);break;case PRODUCTCONTENT:setfootershow(a);break;case PAYCONTENT:setfootershow(a);if(ispayable==false){$("#order-first-item").children(".mainarea-in-list").children("h4").html("休息中");$("#order-first-item").children(".mainarea-in-list").children("h5").html("当前无法交易");$(SUBMITBTN).children(".text-in-btn").html("休息中");$(SUBMITBTN).attr("disabled",true)}else{if(!(totalordernum>0)){$("#order-first-item").children(".mainarea-in-list").children("h4").html("当前订单");$("#order-first-item").children(".mainarea-in-list").children("h5").html("您还没有选中任何订单");$(SUBMITBTN).children(".text-in-btn").html("提交订单");$(SUBMITBTN).attr("disabled",false)}else{$("#order-first-item").children(".mainarea-in-list").children("h4").html("当前订单");if(needdeliveryfee){$("#order-first-item").children(".mainarea-in-list").children("h5").html("总计：￥"+totalpay+"（含外送费：￥"+shopinfo.deliveryfee+"）")}else{$("#order-first-item").children(".mainarea-in-list").children("h5").html("总计：￥"+totalpay)}$(SUBMITBTN).children(".text-in-btn").html("提交订单");$(SUBMITBTN).attr("disabled",false)}}if((totalordernum>0)){$(CLEARBTN).show();$(HAVELOOKBTN).hide()}else{$(CLEARBTN).hide();$(HAVELOOKBTN).show()}break}}function setfootershow(a){switch(a){case SORTCONTENT:$(BACKBTN).hide();$(SORTBTN).hide();$(PAYBTN).show();$("body").removeClass();$("body").addClass("body-with-footer");$("#paytitle").hide();$("#mainfooter").removeClass();$("#mainfooter").addClass("footer-to-bottom");break;case PRODUCTCONTENT:$(BACKBTN).hide();$(SORTBTN).show();$(PAYBTN).show();$("body").removeClass();$("body").addClass("body-with-footer");$("#paytitle").hide();$("#mainfooter").removeClass();$("#mainfooter").addClass("footer-to-bottom");break;case PAYCONTENT:$(BACKBTN).show();$(SORTBTN).hide();$(PAYBTN).hide();$("body").removeClass();$("body").addClass("body-with-header");$("#paytitle").show();$("#mainfooter").removeClass();$("#mainfooter").addClass("footer-to-top");break}if(ispayable==false){$(PAYBTN).attr("disabled",true);$(PAYBTN).children(".text-in-btn").html("休息中");$(PAYBTN).children(".img-in-btn").css("background",getbackground(INSLEEPBTN))}else{$(PAYBTN).attr("disabled",false);$(PAYBTN).children("img-in-btn").css("background",getbackground(PAYBTN));if(totalpay>0&&totalordernum>0){$(PAYBTN).addClass("btn-highlight")}else{$(PAYBTN).removeClass("btn-highlight")}$(PAYBTN).children(".text-in-btn").html("结算 ￥"+totalpay)}}function setproductitemshow(a){var d=findorderbyid(a);var c=findproductbyid(a);if(ispayable==false){$("#product-"+a).children(".p-aside").hide();$("#product-"+a).children(".tipsarea-in-list").show();$("#product-"+a).children(".btnarea-in-list").hide();$("#product-"+a).children(".tipsarea-in-list").children("h4").html("休息中")}else{if(d<0||c<0||orderarray[d].count<=0){$("#product-"+a).children(".p-aside").hide();if(productarray[c].productleft<=0){$("#product-"+a).children(".tipsarea-in-list").show();$("#product-"+a).children(".btnarea-in-list").hide();$("#product-"+a).children(".tipsarea-in-list").children("h4").html("已售罄")}else{$("#product-"+a).children(".tipsarea-in-list").hide();$("#product-"+a).children(".btnarea-in-list").show();$("#product-"+a).children(".btnarea-in-list").children(MINUSBTN).attr("disabled",true);$("#product-"+a).children(".btnarea-in-list").children(PLUSBTN).attr("disabled",false)}}else{$("#product-"+a).children(".p-aside").show();$("#product-"+a).children(".tipsarea-in-list").hide();$("#product-"+a).children(".btnarea-in-list").show();if(orderarray[d].count<productarray[c].productleft){$("#product-"+a).children(".btnarea-in-list").children(MINUSBTN).attr("disabled",false);$("#product-"+a).children(".btnarea-in-list").children(PLUSBTN).attr("disabled",false);var b="已点数量:"+orderarray[d].count;$("#product-"+a).children(".p-aside").html(b)}else{if(orderarray[d].count==productarray[c].productleft){$("#product-"+a).children(".btnarea-in-list").children(MINUSBTN).attr("disabled",false);$("#product-"+a).children(".btnarea-in-list").children(PLUSBTN).attr("disabled",true);var b="已点数量:"+orderarray[d].count;$("#product-"+a).children(".p-aside").html(b)}else{$("#product-"+a).children(".btnarea-in-list").children(MINUSBTN).attr("disabled",false);$("#product-"+a).children(".btnarea-in-list").children(PLUSBTN).attr("disabled",true);var b="库存不足！";$("#product-"+a).children(".p-aside").html(b)}}}}}function setorderitemshow(a){var d=findproductbyid(a);var c=findorderbyid(a);if(d<0||c<0||orderarray[c].count<=0){$("#order-"+a).remove()}else{if(ispayable==false){$("#order-"+a).children(".p-aside").hide();$("#order-"+a).children(".tipsarea-in-list").show();$("#order-"+a).children(".btnarea-in-list").hide();$("#order-"+a).children(".tipsarea-in-list").children("h4").html("休息中")}else{$("#order-"+a).children(".p-aside").show();$("#order-"+a).children(".tipsarea-in-list").hide();$("#order-"+a).children(".btnarea-in-list").show();if(orderarray[c].count<productarray[d].productleft){$("#order-"+a).children(".btnarea-in-list").children(MINUSBTN).attr("disabled",false);
$("#order-"+a).children(".btnarea-in-list").children(PLUSBTN).attr("disabled",false);var b="已点数量:"+orderarray[c].count;$("#order-"+a).children(".p-aside").html(b)}else{if(orderarray[c].count==productarray[d].productleft){$("#order-"+a).children(".btnarea-in-list").children(MINUSBTN).attr("disabled",false);$("#order-"+a).children(".btnarea-in-list").children(PLUSBTN).attr("disabled",true);var b="已点数量:"+orderarray[c].count;$("#order-"+a).children(".p-aside").html(b)}else{$("#order-"+a).children(".btnarea-in-list").children(MINUSBTN).attr("disabled",false);$("#order-"+a).children(".btnarea-in-list").children(PLUSBTN).attr("disabled",true);var b="库存不足！";$("#order-"+a).children(".p-aside").html(b)}}}}}function Toast(b,a){$("#mytoast").html(b);$("#mytoast").removeClass("toast-hide");$("#mytoast").addClass("toast-show");a=isNaN(a)?3000:a;clearTimeout(mytoasttimeout);mytoasttimeout=setTimeout(function(){$("#mytoast").removeClass("toast-show");$("#mytoast").addClass("toast-hide")},a)}function firstcallcontent(){footerprepare();personalinfoprepare();if(firstsortid>=0){showproductcontent(firstsortid)}else{showsortcontent()}contenteventbind()}function refreshcontent(){switch(currentcontent){case SORTCONTENT:showsortcontent();break;case PRODUCTCONTENT:showproductcontent();break;case PAYCONTENT:showpaycontent();break}sortcontentscroll=0;productcontentscroll=0}function submit(){var d=new Array();var c=new Array();var b=0;for(var a=0;a<orderarray.length;a++){var e=findproductbyid(orderarray[a].productid);if(orderarray[a].count>0&&e>=0){d[b]=orderarray[a].productid;c[b]=orderarray[a].count;b++}}if(!isverified){Toast("非验证状态无法下单",2000);$("html, body").animate({scrollTop:0},500)}else{if(!checkinput("#name")){Toast("请正确输入您的姓名",2000);$("#name").focus()}else{if(!checkinput("#number")){Toast("请正确输入您的手机号或电话号码",2000);$("#number").focus()}else{if(!checkselect("#select-area")){Toast("请选择合适的外送片区",2000);$("#select-area").focus()}else{if(!checkinput("#areadesc")){Toast("请正确输入您的详细外送地址",2000);$("#areadesc").focus()}else{if(!checkinput("#tips")){Toast("请正确输入您的备注",2000);$("#tips").focus()}else{if(!(totalordernum>0)){Toast("您尚未选择任何商品",2000);$("html, body").animate({scrollTop:0},500)}else{if(!issubmittable){Toast("您的订单尚未达到起送价格",2000);$("html, body").animate({scrollTop:0},500)}else{if(overleft){Toast("您的订单中存在超额",2000);$("html, body").animate({scrollTop:0},500)}else{myuesrname=$("#name").val();myphonenumber=$("#number").val();myareaid=$("#select-area").val();myareadesc=$("#areadesc").val();mytips=$("#tips").val();writeinfolocal(myuesrname,myphonenumber,myareaid,myareadesc);if(confirm("确认提交订单？")){$.ajax({type:"POST",dataType:"json",url:AJAXFORSUBMIT,data:{sellerid:sellerid,openid:openid,wapKey:identitykey,name:myuesrname,phone:myphonenumber,areaid:myareaid,areadesc:myareadesc,tips:mytips,products:d,nums:c},success:function(f,g){if(f.success=="1"){Toast("下单成功",2000);clearorder();orderload()}else{if(f.success=="2"){if(f.result=="user not exsit"||f.result=="wapKey is out"){callwrongkey();Toast("非验证状态无法下单",2000);showpaycontent()}else{if(f.result=="order total is low"||f.result=="areaid is out"||f.result=="service is out"){if(confirm("数据冲突，是否立即更新？")){dataload(false,false,true,false,true)}}else{if(f.result=="number is not enough"||f.result=="product id is out"){if(confirm("数据冲突，是否立即更新？")){dataload(true,true,false,false,false)}}else{if(confirm("数据冲突，是否立即更新？")){dataload(true,true,true,true,true)}}}}}else{if(f.success=="3"){Toast("存在异常输入",2000)}else{callwrongkey();Toast("非验证状态无法下单",2000);showpaycontent()}}}},error:function(f,h,g){Toast("下单失败，请检查网络并重试",4000)},})}}}}}}}}}}}function callsort(){showsortcontent()}function callproduct(b){var a=isNaN(b)?currentsort:b;showproductcontent(a)}function payback(){switch(lastcontent){case SORTCONTENT:callsort();break;case PRODUCTCONTENT:callproduct();break;default:callsort();break}}function topay(){showpaycontent()}function callsuccesspay(a){var b="";b+='<button class="btn-icon-text" onclick=newstart() id="newstart-btn">'+'<span class="text-in-btn">继续下单</span>'+'<span class="img-in-btn" style="background:'+getbackground(NEWSTARTBTN)+';"></span>'+"</button>";$("#newstart-btnarea").html(b);b="";if(a!=null){b+='<p style="font-size:16px;font-weight:700;">订单号：'+a.order_no+"</p>"+"<br />订餐者姓名："+a.name+"<br />联系电话："+a.phone+"<br />收货地点："+a.address+"<br />下单时间："+a.ctime+"<br />订单备注："+(a.tips!=""?a.tips:"无")+"<br />"+"<br />订单明细："+a.order_items+"<br />订单总价：￥"+a.total+"</div>";$("#tips-orderdesc-ordersuccess").html(b)}else{b+="订单获取失败";$("#tips-orderdesc-ordersuccess").html(b)}$(currentcontent).hide();$(PAYSUCCESS).show()}function toclearorder(){if(confirm("您确定清空购物车吗？")){clearorder();switch(currentcontent){case PAYCONTENT:fillpaycontent();break;case PRODUCTCONTENT:setcontentshow(currentcontent);break;default:setcontentframeshow(currentcontent);break}}}function toaddorder(a){if(addorder(a)){switch(currentcontent){case PRODUCTCONTENT:setproductitemshow(a);setcontentframeshow(currentcontent);break;case PAYCONTENT:setorderitemshow(a);
setcontentframeshow(currentcontent);break;default:setcontentframeshow(currentcontent);break}}}function todeleteorder(a){if(deleteorder(a)){switch(currentcontent){case PRODUCTCONTENT:setproductitemshow(a);setcontentframeshow(currentcontent);break;case PAYCONTENT:setorderitemshow(a);setcontentframeshow(currentcontent);break;default:setcontentframeshow(currentcontent);break}}}function havelook(){var a=sortarray.length-1;var b=parseInt(Math.random()*(a+1));showproductcontent(sortarray[b].sortid)}function newstart(){$(PAYSUCCESS).hide();showsortcontent();dataload(true,true,true,true,true)}function checkinput(a){if($.trim($(a).val()).length<=0&&$(a).data("nonull")==true){$(a).prev("label").html("输入不能为空");$(a).prev("label").show();return false}else{if($(a).attr("type")=="tel"&&!checkphonenumber($(a).val())){$(a).prev("label").html("请正确输入手机号或电话号码<br />示例：15353535353 或 02583622222");$(a).prev("label").show();return false}else{if($.trim($(a).val()).length>$(a).data("maxinput")){$(a).prev("label").html("输入过长（"+$(a).data("maxinput")+"字以内）");$(a).prev("label").show();return false}else{$(a).prev("label").html("");$(a).prev("label").hide();return true}}}}function checkphonenumber(a){String.prototype.isMobile=function(){return(/^(1[3|4|5|8][0-9]\d{8})$/.test($.trim(this)))};String.prototype.isTel=function(){return(/^(0\d{2,3}\d{7,8})?$/.test($.trim(this)))};if(a.isMobile()||a.isTel()){return true}else{return false}}function checkselect(b){var a=findarerbyid($(b).val());if(a>=0&&deliveryareaarray[a].areastatus){$(b).next("label").html(deliveryareaarray[a].areadesc);$(b).prev("label").html("");$(b).prev("label").hide();return true}else{$(b).next("label").html("");$(b).prev("label").show();if($(b).val()==null){$(b).prev("label").html("尚未选中任何片区")}else{$(b).prev("label").html("该片区今日不外送，请重新选择")}return false}}function showitemdesc(d){var a=$(d).siblings();for(var b=0;b<a.length;b++){if($(a[b]).data("descexist")==DESCSHOW){hidedesc(a[b])}}var c=$(d).data("descexist");if(c==DESCNOEXIST){initdesc(d)}else{if(c==DESCHIDE){showdesc(d)}else{if(c==DESCSHOW){hidedesc(d)}}}}function initdesc(e){var c=$(e).data("value");var a=findproductbyid(c);if(a>=0){var b=(productarray[a].productdesc!=null&&productarray[a].productdesc!="")?productarray[a].productdesc:"该商品无详细描述";var d="";d+='<div class="descarea-in-list">'+'<img class="myimg" onerror=errorajust(this) src="'+BASEURL+productarray[a].productimg+'" alt="无真相>_<~">'+"<p>"+(b!=""?b:"无描述信息")+"</p>"+"</div>";$(e).append(d)}else{var d="";d+='<div class="descarea-in-list">'+"<p>无数据</p>"+"</div>";$(e).append(d)}$(e).addClass("product-item-showdesc");$(e).data("descexist",DESCSHOW);$(e).children(".showmore").hide()}function hidedesc(a){$(a).children(".descarea-in-list").hide();$(a).removeClass("product-item-showdesc");$(a).data("descexist",DESCHIDE);$(a).children(".showmore").show()}function showdesc(a){$(a).children(".descarea-in-list").show();$(a).addClass("product-item-showdesc");$(a).data("descexist",DESCSHOW);$(a).children(".showmore").hide()}function errorajust(a){$(a).css("height","100px");$(a).css("background","#fff")}function getbackground(b){var a=0;switch(b){case SORTBTN:a=0;break;case BACKBTN:a=1;break;case PAYBTN:a=2;break;case CLEARBTN:a=3;break;case HAVELOOKBTN:a=4;break;case SUBMITBTN:a=5;break;case MINUSBTN:a=6;break;case PLUSBTN:a=7;break;case RIGHTARROR:a=8;break;case NEWSTARTBTN:a=10;break;case INSLEEPBTN:a=11;break}var d=0-a*ICONSIZE;var c="url("+BASEURLICON+") no-repeat "+d+"px 0";return c};